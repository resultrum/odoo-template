# üìö Developer Guide - Odoo-MTA Setup & Workflow

**Version:** 1.0
**Last Updated:** October 30, 2025
**Project:** odoo-mta (MOTECMA - Metrum Odoo Technical Management)

---

## Table of Contents

1. [Quick Start](#quick-start)
2. [Architecture Overview](#architecture-overview)
3. [Git-Aggregator Workflow](#git-aggregator-workflow)
4. [Developer Workflows](#developer-workflows)
   - [Scenario 1: Modify an OCA Module](#scenario-1-modify-an-oca-module)
   - [Scenario 2: Add a New OCA Repository](#scenario-2-add-a-new-oca-repository)
   - [Scenario 3: Create a Custom Metrum Module](#scenario-3-create-a-custom-metrum-module)
5. [Troubleshooting](#troubleshooting)
6. [Reference](#reference)

---

## Quick Start

### Prerequisites

- Docker Desktop (running)
- Git with SSH keys configured for GitHub
- PyCharm (recommended)

### First-Time Setup

```bash
# 1. Clone the project
git clone https://github.com/resultrum/odoo-mta.git
cd odoo-mta

# 2. Copy environment configuration
cp .env.example .env

# 3. Create symlinks for OCA modules
./scripts/create-oca-symlinks.sh

# 4. Start Docker (dev mode)
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d

# 5. Access Odoo
# URL: http://localhost:8069
# Database: mta-dev
# Username: admin
# Password: admin123
```

---

## Architecture Overview

### Directory Structure

```
odoo-mta/
‚îú‚îÄ‚îÄ addons/
‚îÇ   ‚îú‚îÄ‚îÄ custom/                           # Metrum custom modules (mta_* prefix)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mta_example/                  # Example: mta_developer_planning
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ oca/                              # Git-aggregated OCA repositories
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ helpdesk/                     # OCA Helpdesk (merged from git-aggregator)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ helpdesk_mgmt/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ helpdesk_crm/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ... (22 modules total)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ server-tools/                 # (Future) OCA Server Tools
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ oca-addons/                       # Symlinks to all OCA modules
‚îÇ       ‚îú‚îÄ‚îÄ .gitkeep
‚îÇ       ‚îú‚îÄ‚îÄ helpdesk_mgmt -> ../oca/helpdesk/helpdesk_mgmt
‚îÇ       ‚îú‚îÄ‚îÄ helpdesk_crm -> ../oca/helpdesk/helpdesk_crm
‚îÇ       ‚îî‚îÄ‚îÄ ... (auto-generated symlinks)
‚îÇ
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ create-oca-symlinks.sh            # Helper script for symlink generation
‚îÇ
‚îú‚îÄ‚îÄ repos.yml                             # Git-aggregator configuration
‚îú‚îÄ‚îÄ docker-compose.yml                    # Production configuration
‚îú‚îÄ‚îÄ docker-compose.dev.yml                # Development overrides
‚îú‚îÄ‚îÄ entrypoint.sh                         # Container initialization script
‚îú‚îÄ‚îÄ odoo.conf                             # Odoo configuration
‚îú‚îÄ‚îÄ Dockerfile                            # Container image definition
‚îî‚îÄ‚îÄ README.md                             # Project README
```

### Key Components

#### 1. **Git-Aggregator** (repos.yml)

Merges multiple Git branches into a single repository structure.

**How it works:**
- Reads `repos.yml` configuration
- Clones/pulls from multiple Git remotes (OCA + Metrum)
- Merges specified branches
- Outputs consolidated code to `./addons/oca/*/`

**Current Configuration:**
```yaml
./addons/oca/helpdesk:
  remotes:
    oca: git@github.com:OCA/helpdesk.git
    resultrum: git@github.com:resultrum/helpdesk.git
  merges:
    - oca 18.0                           # Take OCA's 18.0 branch
  target: resultrum master-18.0-mta      # Push merged result to custom branch
```

#### 2. **Symlinks** (oca-addons/)

Creates shortcuts from consolidated OCA modules to a flat directory structure.

**Why needed:**
```
Odoo addons_path: /mnt/extra-addons/oca-addons/
Actual modules: /mnt/extra-addons/oca/helpdesk/helpdesk_mgmt/

Symlinks bridge the gap:
/mnt/extra-addons/oca-addons/helpdesk_mgmt ‚Üí ../oca/helpdesk/helpdesk_mgmt
```

**Auto-generated by:** `entrypoint.sh` on container startup

#### 3. **Docker Volumes** (docker-compose.*.yml)

Maps local directories to container paths with proper permissions.

**Production (read-only):**
```yaml
volumes:
  - ./addons/custom:/mnt/extra-addons/custom:ro
  - ./addons/oca:/mnt/extra-addons/oca:ro
  - ./addons/oca-addons:/mnt/extra-addons/oca-addons:ro
```

**Development (read-write):**
```yaml
volumes:
  - ./addons/custom:/mnt/extra-addons/custom:rw
  - ./addons/oca:/mnt/extra-addons/oca:rw
  - ./addons/oca-addons:/mnt/extra-addons/oca-addons:rw
```

---

## Git-Aggregator Workflow

### Understanding repos.yml

The `repos.yml` file controls how OCA repositories are downloaded and merged.

**Structure:**
```yaml
./addons/oca/<repo-name>:           # Local output directory
  remotes:
    oca: <OCA-GITHUB-URL>           # Official OCA repository
    resultrum: <METRUM-FORK-URL>    # Your custom fork
  merges:
    - oca <branch>                  # Which OCA branch to use as base
    - resultrum <custom-branch>     # (Optional) Custom branches to merge
  target: resultrum <target-branch> # Where to push merged result
```

### Activation & Deactivation

**Enable git-aggregator** (to update/sync repositories):

```bash
# Edit docker-compose.dev.yml
# Change: ENABLE_GIT_AGGREGATE=false
# To:     ENABLE_GIT_AGGREGATE=true

# Then restart:
docker-compose down
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d

# Check logs:
docker-compose logs -f web | grep -E "(git-aggregator|symlink)"
```

**Disable git-aggregator** (for local development):

```bash
# Edit docker-compose.dev.yml
# Set: ENABLE_GIT_AGGREGATE=false

docker-compose down
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d
```

### Why Disable by Default in Dev?

- ‚úÖ Faster container startup
- ‚úÖ Avoids permission issues on mounted volumes
- ‚úÖ Local modules already present and synced via Docker volumes
- ‚úÖ Developers can test changes immediately without git operations
- ‚ö†Ô∏è Run git-aggregator explicitly when you need to update repositories

---

## Developer Workflows

### Scenario 1: Modify an OCA Module

**Situation:** Fix a bug in `helpdesk_mgmt` or add a feature

#### Step 1: Fork the OCA Repository (One-time setup)

If Metrum doesn't have a fork yet:

```bash
# Go to GitHub
# 1. Fork https://github.com/OCA/helpdesk to resultrum/helpdesk
# 2. Clone it locally (optional, for understanding structure)
git clone git@github.com:resultrum/helpdesk.git
```

#### Step 2: Create a Custom Branch in Your Fork

```bash
# Navigate to your existing repo
cd addons/oca/helpdesk

# Create a custom feature branch
git checkout -b fix/ticket-assignment-bug

# (or for future reference)
git checkout -b feature/custom-fields

# Make your changes
# ... edit models/helpdesk_ticket.py ...
# ... edit views/helpdesk_views.xml ...
```

#### Step 3: Commit and Push to Your Fork

```bash
# Stage your changes
git add models/helpdesk_ticket.py
git add views/helpdesk_views.xml

# Commit
git commit -m "Fix: resolve ticket auto-assignment issue

This commit addresses the bug where tickets assigned to offline users
were not being redistributed to available staff members."

# Push to your custom branch
git push resultrum fix/ticket-assignment-bug
```

#### Step 4: Update repos.yml to Include Your Branch

Edit `repos.yml`:

```yaml
./addons/oca/helpdesk:
  remotes:
    oca: git@github.com:OCA/helpdesk.git
    resultrum: git@github.com:resultrum/helpdesk.git
  merges:
    - oca 18.0                           # Base OCA version
    - resultrum fix/ticket-assignment-bug # Your custom fix
  target: resultrum master-18.0-mta
```

**Key:** The order of `merges` matters! OCA goes first (base), then your branch (applies changes on top).

#### Step 5: Enable and Run Git-Aggregator

```bash
# Edit docker-compose.dev.yml
# Change: ENABLE_GIT_AGGREGATE=false
# To:     ENABLE_GIT_AGGREGATE=true

# Restart Docker
docker-compose down
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d

# Monitor logs
docker-compose logs -f web | head -50
```

**Expected output:**
```
odoo-mta-web  | üîß DEV MODE: Running git-aggregator...
odoo-mta-web  | ‚úÖ git-aggregator completed
odoo-mta-web  | üîó Setting up OCA addons symlinks...
odoo-mta-web  | ‚úÖ OCA addons symlinks created successfully
odoo-mta-web  | 2025-10-30 08:43:31,419 1 INFO ? odoo: addons paths: [...'/mnt/extra-addons/oca-addons']
```

#### Step 6: Reload Module in Odoo

```
1. Go to Odoo: http://localhost:8069
2. Switch to Developer Mode (‚öôÔ∏è Settings ‚Üí Activate Developer Mode)
3. Go to Apps ‚Üí Search for "helpdesk_mgmt"
4. Click the module ‚Üí Click "Reload" button
5. Verify your changes are active
```

#### Step 7: Test Your Changes

- Test the functionality in Odoo
- Run automated tests if available
- Once validated, keep git-aggregator enabled or disable it after testing

#### Step 8: Merge Back to master-18.0-mta (Optional)

After your feature is stable:

```bash
cd addons/oca/helpdesk

# Checkout target branch
git checkout master-18.0-mta

# Merge your feature branch
git merge fix/ticket-assignment-bug

# Push to update the target branch
git push resultrum master-18.0-mta

# Remove the feature branch
git branch -d fix/ticket-assignment-bug
git push resultrum --delete fix/ticket-assignment-bug
```

Then in `repos.yml`, you can remove the feature branch from merges:

```yaml
./addons/oca/helpdesk:
  remotes:
    oca: git@github.com:OCA/helpdesk.git
    resultrum: git@github.com:resultrum/helpdesk.git
  merges:
    - oca 18.0
    # - resultrum fix/ticket-assignment-bug  (deleted, already in master-18.0-mta)
  target: resultrum master-18.0-mta
```

---

### Scenario 2: Add a New OCA Repository

**Situation:** You want to add OCA's sale-related modules (sale module)

#### Step 1: Create a Fork for the New Repository

```bash
# On GitHub:
# 1. Fork https://github.com/OCA/sale to resultrum/sale
# 2. Note: You can fork to an existing Metrum organization if preferred
```

#### Step 2: Add to repos.yml

Edit `repos.yml` and add:

```yaml
./addons/oca/helpdesk:
  remotes:
    oca: git@github.com:OCA/helpdesk.git
    resultrum: git@github.com:resultrum/helpdesk.git
  merges:
    - oca 18.0
  target: resultrum master-18.0-mta

# ADD NEW REPO:
./addons/oca/sale:                       # New directory
  remotes:
    oca: git@github.com:OCA/sale.git
    resultrum: git@github.com:resultrum/sale.git
  merges:
    - oca 18.0
  target: resultrum master-18.0-mta
```

#### Step 3: Enable Git-Aggregator and Restart

```bash
# Edit docker-compose.dev.yml
# Set: ENABLE_GIT_AGGREGATE=true

docker-compose down
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d

# Check logs
docker-compose logs -f web
```

**Expected steps:**
1. Git-aggregator clones `OCA/sale` repo
2. Checks out `18.0` branch
3. Creates/updates `resultrum/master-18.0-mta` with merged content
4. Stores everything in `./addons/oca/sale/`
5. Symlinks created: `./addons/oca-addons/sale_*` ‚Üí `../oca/sale/sale_*/`

#### Step 4: Update Odoo Apps List

```
1. Go to Odoo: http://localhost:8069
2. Apps ‚Üí Update Apps List (‚ü≥ button)
3. Search for "sale" to see new modules
4. Install as needed
```

#### Step 5: Disable Git-Aggregator (Optional)

Once synced, you can disable it again for faster dev cycles:

```bash
# Edit docker-compose.dev.yml
# Set: ENABLE_GIT_AGGREGATE=false

docker-compose down
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d
```

**Note:** The modules remain locally, so Odoo still sees them via symlinks.

---

### Scenario 3: Create a Custom Metrum Module

**Situation:** Build the developer planning module (`mta_developer_planning`)

#### Step 1: Create Directory Structure

```bash
mkdir -p addons/custom/mta_developer_planning/{models,views,security,static/description}
cd addons/custom/mta_developer_planning
```

#### Step 2: Create __init__.py Files

`models/__init__.py`:
```python
from . import developer
```

`__init__.py` (root):
```python
from . import models
```

#### Step 3: Create Module Manifest

`__manifest__.py`:
```python
{
    'name': 'Developer Planning',
    'version': '18.0.1.0.0',
    'category': 'Tools',
    'author': 'Metrum',
    'depends': ['base', 'helpdesk_mgmt'],
    'data': [
        'security/ir.model.access.csv',
        'views/developer_views.xml',
        'views/developer_menus.xml',
    ],
    'installable': True,
    'auto_install': False,
    'application': False,
}
```

#### Step 4: Create Models

`models/developer.py`:
```python
from odoo import models, fields

class Developer(models.Model):
    _name = 'developer.developer'
    _description = 'Developer'

    name = fields.Char('Name', required=True)
    email = fields.Char('Email')
    capacity = fields.Float('Capacity (hours/week)', default=40.0)
    skills = fields.Char('Skills')
```

#### Step 5: Create Views and Menus

`views/developer_menus.xml`:
```xml
<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <menuitem id="menu_developer" name="Developers" />
</odoo>
```

`views/developer_views.xml`:
```xml
<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="view_developer_tree" model="ir.ui.view">
        <field name="name">developer.tree</field>
        <field name="model">developer.developer</field>
        <field name="arch" type="xml">
            <tree>
                <field name="name" />
                <field name="email" />
                <field name="capacity" />
            </tree>
        </field>
    </record>
</odoo>
```

#### Step 6: Create Security Rules

`security/ir.model.access.csv`:
```
id,name,model_id:id,group_id:id,perm_read,perm_write,perm_create,perm_unlink
access_developer_user,Developer User,model_developer_developer,base.group_user,1,0,0,0
access_developer_manager,Developer Manager,model_developer_developer,base.group_system,1,1,1,1
```

#### Step 7: Odoo Auto-Detects Your Module

- Docker volumes sync the new directory
- `entrypoint.sh` detects it automatically (doesn't use symlinks for custom/)
- Go to **Apps** ‚Üí **Update Apps List**
- Search for "Developer Planning" and install

---

## Troubleshooting

### Git-Aggregator Issues

#### "Permission denied" errors

**Symptom:**
```
chown: changing ownership of '.../pack/...pack': Permission denied
```

**Solution:**
- This happens when mounted volumes have permission issues
- It's safe to ignore if git-aggregator completes
- Keep `ENABLE_GIT_AGGREGATE=false` in dev mode by default

#### Git authentication fails

**Symptom:**
```
fatal: Authentication failed for 'https://github.com/OCA/helpdesk.git'
```

**Solution:**
```bash
# Ensure SSH keys are properly configured
# 1. Check SSH connection
ssh -T git@github.com

# 2. Add SSH key to ssh-agent (macOS)
ssh-add ~/.ssh/id_ed25519

# 3. Verify Docker can access SSH keys
docker exec odoo-mta-web ssh -T git@github.com
```

#### Symlinks not created

**Symptom:**
```
ls -la addons/oca-addons/
# Returns only .gitkeep
```

**Solution:**
```bash
# Manually regenerate symlinks
./scripts/create-oca-symlinks.sh

# Or in Docker:
docker exec odoo-mta-web bash -c "
  mkdir -p /mnt/extra-addons/oca-addons
  find /mnt/extra-addons/oca-addons -maxdepth 1 -type l -delete
  for module_dir in /mnt/extra-addons/oca/*/; do
    for module in \"\$module_dir\"*/; do
      if [ -f \"\$module/__manifest__.py\" ]; then
        module_name=\$(basename \"\$module\")
        ln -sf \"../oca/\$(basename \"\$module_dir\")/\$module_name\" \
               \"/mnt/extra-addons/oca-addons/\$module_name\"
      fi
    done
  done
"
```

### Docker Issues

#### Container keeps stopping

**Symptom:**
```
docker-compose logs web
# Shows repeated errors and exit
```

**Solution:**
```bash
# 1. Check database initialization
docker-compose down
docker exec odoo-mta-web odoo -i base -d mta-dev --stop-after-init

# 2. Restart
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d
```

#### Permission errors on volumes

**Symptom:**
```
Permission denied when editing files in addons/
```

**Solution:**
```bash
# Fix permissions
chmod -R 755 addons/

# Or in Docker:
docker exec odoo-mta-web chown -R odoo:odoo /mnt/extra-addons/
```

---

## Reference

### Useful Commands

```bash
# Start development environment
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d

# View logs
docker-compose logs -f web

# Access container shell
docker exec -it odoo-mta-web bash

# Initialize/reset database
docker-compose down
docker exec odoo-mta-web odoo -i base -d mta-dev --stop-after-init

# Regenerate symlinks
./scripts/create-oca-symlinks.sh

# Stop containers
docker-compose down
```

### Git Commands (in OCA repos)

```bash
# Inside addons/oca/helpdesk/

# View branches
git branch -a

# Create feature branch
git checkout -b feature/my-feature

# Push to fork
git push resultrum feature/my-feature

# Create merge request (on GitHub)
# Pull request: feature/my-feature ‚Üí master-18.0-mta

# Merge locally
git checkout master-18.0-mta
git merge feature/my-feature
git push resultrum master-18.0-mta
```

### Configuration Files

**repos.yml** - Git-aggregator configuration
- Location: `./repos.yml`
- Update when: adding repos, modifying merge branches

**docker-compose.dev.yml** - Development overrides
- Location: `./docker-compose.dev.yml`
- Update: `ENABLE_GIT_AGGREGATE` flag only

**odoo.conf** - Odoo server configuration
- Location: `./odoo.conf`
- Key setting: `addons_path = .../oca-addons`

**entrypoint.sh** - Container initialization
- Location: `./entrypoint.sh`
- Creates symlinks automatically

### Environment Variables

| Variable | Default | Purpose |
|----------|---------|---------|
| `ENABLE_GIT_AGGREGATE` | `false` | Run git-aggregator on startup |
| `HOST` | `db` | Database hostname |
| `USER` | `odoo` | Database username |
| `PASSWORD` | `odoo` | Database password |

---

## Workflow Summary

| Task | Command | Time |
|------|---------|------|
| **Add new OCA repo** | Edit `repos.yml`, enable git-aggregate, restart Docker | ~5-10 min |
| **Modify OCA module** | Edit file ‚Üí Auto-reload in Odoo | Instantaneous |
| **Create custom module** | `mkdir addons/custom/mta_*` | 1-2 min |
| **Sync repositories** | Enable git-aggregate, restart Docker | ~10-15 min |
| **Update module list** | Odoo: Apps ‚Üí Update Apps List | 1-2 min |

---

## Technical Summary

```
Architecture:
‚îú‚îÄ‚îÄ Git-Aggregator (repos.yml)
‚îÇ   ‚îî‚îÄ Merges OCA + Metrum branches ‚Üí ./addons/oca/*/
‚îú‚îÄ‚îÄ Symlinks (./addons/oca-addons/)
‚îÇ   ‚îî‚îÄ Bridges to Odoo addons_path
‚îî‚îÄ‚îÄ Docker Volumes
    ‚îî‚îÄ Syncs local changes in real-time (dev mode)

Workflow:
1. Developer modifies ./addons/oca/helpdesk/helpdesk_mgmt/models.py
2. Docker volume syncs ‚Üí /mnt/extra-addons/oca/helpdesk/helpdesk_mgmt/
3. Symlink: /mnt/extra-addons/oca-addons/helpdesk_mgmt ‚Üí ../oca/...
4. Odoo --dev=reload detects change and reloads module
5. Developer sees change in browser instantly

Git Integration:
1. Developer creates custom branch: resultrum/feature/my-fix
2. Adds to repos.yml merges section
3. Enables git-aggregator and restarts Docker
4. Git-aggregator: merge oca/18.0 + resultrum/feature/my-fix ‚Üí local copy
5. Changes available in Odoo immediately
6. Developer tests, commits, and optionally merges to master-18.0-mta
```

---

## Best Practices

1. **Always create feature branches** for OCA modifications
2. **Keep git-aggregator disabled** in dev for faster startup
3. **Enable git-aggregator only when** adding/updating repositories
4. **Commit frequently** to your custom branches in Git
5. **Test in Odoo** before pushing to master-18.0-mta
6. **Document** any custom branches in repos.yml comments
7. **Keep master-18.0-mta clean** - only merge tested, production-ready code

---

**Questions?** Check the Troubleshooting section or reach out to the team.
