# Production-specific overrides for docker-compose
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# This file overrides development settings for production environment

version: '3.8'

services:
  web:
    image: resultrum/odoo-mta:prod-latest  # Use production image
    container_name: odoo-mta-web-prod

    # Production environment variables
    environment:
      # Database
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: mta-prod
      DB_USER: odoo
      DB_PASSWORD: ${DB_PASSWORD}  # Must be set via environment

      # Odoo settings
      ODOO_ADMIN_PASSWORD: ${ODOO_ADMIN_PASSWORD}  # Must be set via environment

      # Production flags
      ENABLE_GIT_AGGREGATE: "false"  # Don't run git-aggregator in production
      DISABLE_DEV_MODE: "true"  # Disable development features

      # Security
      SECURE_COOKIES: "true"
      SESSION_COOKIE_SECURE: "true"
      SESSION_COOKIE_HTTPONLY: "true"
      SESSION_COOKIE_SAMESITE: "Strict"

      # Performance
      WORKERS: 8  # Multiple workers for production
      WORKER_CLASS: gevent
      MAX_POOL_SIZE: 20
      TIMEOUT: 120

      # Logging
      LOG_LEVEL: info  # Less verbose logging

    # Mount volumes as read-only in production
    volumes:
      # Code volumes (read-only)
      - ./addons/custom:/mnt/extra-addons/custom:ro
      - ./addons/oca-addons:/mnt/extra-addons/oca-addons:ro
      - ./odoo.conf:/etc/odoo/odoo.conf:ro
      - ./entrypoint.sh:/entrypoint.sh:ro

      # Data volumes (read-write for Odoo data)
      - odoo-prod-data:/var/lib/odoo/.local/share/Odoo/filestore
      - odoo-prod-sessions:/var/lib/odoo/sessions

    # Restart policy
    restart: always
    depends_on:
      postgres:
        condition: service_healthy

    # Security options
    security_opt:
      - no-new-privileges:true

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8069/web/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

  postgres:
    image: postgres:15-alpine
    container_name: odoo-mta-db-prod

    # Production environment
    environment:
      POSTGRES_USER: odoo
      POSTGRES_PASSWORD: ${DB_PASSWORD}  # Must be set via environment
      POSTGRES_DB: mta-prod

      # PostgreSQL settings for production
      POSTGRES_INITDB_ARGS: >
        -c max_connections=200
        -c shared_buffers=256MB
        -c effective_cache_size=768MB
        -c maintenance_work_mem=64MB
        -c checkpoint_completion_target=0.9
        -c wal_buffers=16MB
        -c default_statistics_target=100
        -c random_page_cost=1.1
        -c effective_io_concurrency=200
        -c work_mem=1310kB
        -c min_wal_size=2GB
        -c max_wal_size=4GB

    # Mount data volume for persistence
    volumes:
      - postgres-prod-data:/var/lib/postgresql/data
      # Optional: mount backup location
      - ${BACKUP_PATH:-/backups/odoo-mta/prod}:/backups:ro

    # Restart policy
    restart: always

    # Health check
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U odoo -d mta-prod"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    # Security options
    security_opt:
      - no-new-privileges:true

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

  nginx:
    # Optional: Use nginx as reverse proxy in production
    image: nginx:alpine
    container_name: odoo-mta-nginx-prod
    restart: always

    ports:
      - "80:80"
      - "443:443"

    volumes:
      # Configuration (if you have one)
      # - ./nginx.conf:/etc/nginx/nginx.conf:ro
      # SSL certificates
      - /etc/letsencrypt:/etc/letsencrypt:ro
      # Cache
      - nginx-cache:/var/cache/nginx

    depends_on:
      - web

    security_opt:
      - no-new-privileges:true

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

# Named volumes for production
volumes:
  postgres-prod-data:
    driver: local
  odoo-prod-data:
    driver: local
  odoo-prod-sessions:
    driver: local
  nginx-cache:
    driver: local

networks:
  default:
    name: odoo-mta-prod
